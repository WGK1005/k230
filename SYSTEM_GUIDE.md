# K230 红色物体跟踪系统 - 完整项目说明

## 📦 项目文件清单

| 文件 | 功能 | 说明 |
|------|------|------|
| **change1.py** | 主程序（上位机） | K230摄像头处理+舵机控制+通信 |
| **wheel_controller.py** | 下位机控制器 | MCU接收命令+电机驱动 |
| **config.py** | 全局配置文件 | 所有参数集中管理 |
| **test_system.py** | 系统测试套件 | 逐个测试各模块 |
| **color_calibrator.py** | 颜色校准工具 | 获取最佳红色阈值 |
| **README.md** | 详细配置指南 | 硬件接线、参数调优、故障排除 |
| **QUICK_START.md** | 快速启动指南 | 5分钟快速上手、调试技巧 |

---

## 🎯 工作流程

### 1️⃣ 初始化阶段
```python
# 启动change1.py
# ├─ 初始化舵机到中点位置
# ├─ 启动摄像头捕获
# ├─ 初始化UART通信
# └─ 启动主控制循环
```

### 2️⃣ 实时检测阶段
```
每帧(50ms):
  1. 捕获摄像头画面
  2. LAB颜色空间检测红色
  3. 找到最大色块
  4. 计算屏幕中心偏移
  5. PID控制器计算输出
  6. 驱动舵机到新位置
  7. 发送坐标给下位机
  8. 显示调试信息到LCD
```

### 3️⃣ 下位机处理
```
MCU (wheel_controller.py):
  1. 接收UART数据
  2. 解析$TARGET或$SERVO命令
  3. 计算轮子速度
  4. 驱动电机
```

---

## 🔌 硬件接线图

### 舵机连接
```
K230 Pin46 (PWM2) ──── 水平舵机信号线 (MG966R)
K230 Pin47 (PWM3) ──── 垂直舵机信号线 (MG966R)
6V独立电源 ────────── 舵机电源（2A以上）
```

### 串口连接
```
K230 Pin11 (UART2_TX) ──── MCU RX
K230 Pin12 (UART2_RX) ──── MCU TX
K230 GND ───────────────── MCU GND
```

### 摄像头
```
摄像头接K230标准FPC连接器 (已集成)
```

---

## ⚙️ 核心参数说明

### PID控制参数

**Kp (比例系数)**
- 增大 → 响应快但可能震荡
- 推荐: 0.5-1.0
- 用途: 主要控制输出

**Ki (积分系数)**
- 增大 → 消除稳态误差
- 推荐: 0.05-0.1
- 注意: 过大会导致超调

**Kd (微分系数)**
- 增大 → 阻尼作用，减少震荡
- 推荐: 0.1-0.3
- 注意: 对噪声敏感

### 颜色阈值

LAB色彩空间:
- **L (亮度)**: 0-100
- **A (红绿)**: -128~127 (正值偏红)
- **B (黄蓝)**: -128~127 (正值偏黄)

推荐红色范围: `(20, 80, 30, 100, 0, 60)`

---

## 🧪 测试和调试

### 第1步: 硬件自检
```bash
# 上传test_system.py并运行
# 检查: PWM / UART / 摄像头 / 显示屏 / 色块检测 / PID
```

### 第2步: 舵机校准
```python
# 手动控制舵机找出实际的脉宽范围
# 某些舵机可能不是标准的500-2500us
from change1 import servo
servo.set_position(-90, 0)  # 左转90°
servo.set_position(90, 0)   # 右转90°
```

### 第3步: 颜色校准
```bash
# 运行color_calibrator.py获取实际的LAB值
# 展示红色物体在屏幕中心，查看实时值
python color_calibrator.py
```

### 第4步: PID调优
```python
# 修改config.py的PID参数
# 观察舵机跟踪效果：
# - 响应快但震荡？ → 增加Kd
# - 响应慢？ → 增加Kp
# - 无法准确到达目标？ → 增加Ki
```

---

## 📊 数据流向

```
摄像头捕获
    ↓
[480x800 RGB565图像]
    ↓
LAB色彩空间转换 + Blob检测
    ↓
[色块坐标 (x, y) 和大小]
    ↓
计算偏移量
  offset_x = x - CX
  offset_y = y - CY
    ↓
PID控制器计算
    ↓
[舵机角度输出] → PWM驱动舵机
[坐标数据]    → UART发送MCU
    ↓
LCD显示调试信息
    ↓
循环 (50ms)
```

---

## 🚨 故障排查速查表

| 现象 | 最可能的原因 | 解决方案 |
|------|-----------|--------|
| 舵机不动 | 电源不足 / PWM引脚错 | 用万用表测舵机电源，检查Pin46/47 |
| 无法检测红色 | 颜色阈值不对 | 运行color_calibrator.py调整 |
| 舵机震荡 | PID参数不合理 | 增加Kd或减少Kp |
| 下位机收不到数据 | 波特率不同步 | 确认都是115200 |
| LCD黑屏 | 显示屏初始化失败 | 检查Display.init()参数 |

---

## 💡 进阶优化建议

### 1. 提高跟踪精度
```python
# 使用卡尔曼滤波
# 平滑舵机运动，减少抖动
```

### 2. 支持多物体
```python
# 跟踪多个红色物体
# 选择最近的或最大的
```

### 3. 背景消除
```python
# 背景差分法
# 只跟踪前景物体
```

### 4. 自适应曝光
```python
# 根据环境光自动调整
# 在不同光照下都能工作
```

---

## 📚 文件详细说明

### change1.py (主程序)

**核心类:**
- `ServoController`: 舵机控制
- `SimplePID`: PID算法
- `WheelMotorComm`: 串口通信

**主要流程:**
```
初始化硬件
├─ 舵机初始化到中点
├─ 摄像头初始化
├─ UART初始化
└─ 显示屏初始化

主循环(20Hz):
├─ 捕获帧
├─ 色块检测
├─ PID控制
├─ 舵机驱动
├─ UART发送
└─ LCD显示
```

### wheel_controller.py (下位机)

**核心类:**
- `WheelController`: 接收和处理命令

**命令格式:**
```
$TARGET,x,y,valid  → 目标坐标
$SERVO,pan,tilt    → 舵机位置
```

### config.py (配置文件)

集中管理所有参数，方便全局调整。

---

## 🎓 学习资源

1. **MicroPython文档**: https://docs.micropython.org
2. **OpenMV文档**: https://openmv.io/wiki
3. **K230官方**: https://www.lckfb.com
4. **舵机型号**: MG966R 360° 连续旋转舵机

---

## 📝 版本历史

- **v1.0** (2025-01-XX)
  - 基础功能实现
  - 舵机控制
  - 色块检测
  - PID控制
  - 串口通信

---

## 🤝 反馈和改进

如果你有任何建议或发现问题，请：

1. 检查README.md的常见问题
2. 运行test_system.py进行自诊断
3. 查看QUICK_START.md的故障排除部分

---

**祝你使用愉快！** 🚀

如有问题，欢迎在K230论坛反馈！
